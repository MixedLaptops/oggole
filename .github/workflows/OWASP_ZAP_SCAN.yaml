name: OWASP ZAP Scan

on:
  push:
    branches: [main]  # adjust branches you want to scan on
  pull_request:

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  owasp-zap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'  # or the version your project uses

      - name: Build the Go web app
        run: |
          cd src  # assuming your Go code is under src/
          go mod tidy
          go build -o oggole-server ./backend  # adjust path if needed
          ./oggole-server &             # start the server
          sleep 10                       # wait for the server to be fully up
        working-directory: ./    # or root if src is at root

      - name: Ensure the app is running
        run: |
          curl --retry 5 --retry-connrefused --retry-delay 5 http://localhost:8080
          # adjust port if your server uses another port

      - name: Run OWASP ZAP baseline scan
        run: |
          sudo chmod -R a+w $(pwd)
          docker run --add-host=host.docker.internal:host-gateway \
             -v $(pwd):/zap/wrk -w /zap/wrk ghcr.io/zaproxy/zaproxy:stable \
             /bin/bash -c "zap-baseline.py -t http://host.docker.internal:8080 \
             -a -r zap-report.html -J zap-report.json -x zap-report.xml || true"

      - name: Upload OWASP ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap_report
          path: |
            zap-report.html
            zap-report.json
            zap-report.xml

      - name: Upload ZAP results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: zap-report.json
